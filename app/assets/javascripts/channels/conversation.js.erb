console.log(<%= Conversation.all.length %>);

<% Conversation.all.each do |conversation| %>

  App['room' + <%= conversation.id %>] = App.cable.subscriptions.create(
    {
      channel: "ConversationChannel",
      room: <%= conversation.id %>
    }, {
      connected: function() {
        scroll_bottom();
      },

      disconnected: function() {},

      received: function(data) {
        const parser = new DOMParser();

        const doc = parser.parseFromString(data.message, "text/html");
        const messageTemplate = doc.firstChild.lastChild.firstChild;

        document.getElementById('messages').appendChild(messageTemplate);
        scroll_bottom();
      }
    }
  );
<% end %>

function scroll_bottom() {
  $('#messages').scrollTop($('#messages')[0].scrollHeight)
}
